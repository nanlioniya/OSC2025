
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Lab 8: Non-volatile Storage &#8212; IOC5226: Operating System Capstone</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Hardware" href="hardware/index.html" />
    <link rel="prev" title="Lab 7: Virtual File System" href="lab7.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">IOC5226: Operating System Capstone</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Class:
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../class/staff.html">
   Staff
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Labs:
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="overview.html">
   Overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lab0.html">
   Lab 0: Environment Setup
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lab1.html">
   Lab 1: Hello World
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lab2.html">
   Lab 2: Booting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lab3.html">
   Lab 3: Exception and Interrupt
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lab4.html">
   Lab 4: Allocator
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lab5.html">
   Lab 5: Thread and User Process
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lab6.html">
   Lab 6: Virtual Memory
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lab7.html">
   Lab 7: Virtual File System
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Lab 8: Non-volatile Storage
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="hardware/index.html">
   Hardware
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="hardware/asm.html">
     The Assembly You Need
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="hardware/mailbox.html">
     Mailbox
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="hardware/uart.html">
     UART
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  References:
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../references/external_resources.html">
   External Resourses
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../references/old_course.html">
   Old Course Websites
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/labs/lab8.rst.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.rst</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#goals-of-this-lab">
   Goals of this lab
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#background">
   Background
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fat-file-system">
     FAT File System
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#short-file-names-sfn-and-long-file-names-lfn">
     Short File Names (SFN) and Long File Names (LFN)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sd-card">
     SD Card
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#sd-card-driver">
       SD Card Driver
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#sd-card-on-qemu">
       SD Card on QEMU
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#sd-card-on-linux">
       SD Card on Linux
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#sector">
       Sector
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#block">
       Block
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#cluster">
       Cluster
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#basic-exercises">
   Basic Exercises
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-partition">
     Get Partition
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mount-fat32">
     Mount FAT32
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#basic-exercise-1-open-and-read-40">
     Basic Exercise 1 - Open and Read - 40%
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#lookup-and-open">
       Lookup and Open
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#read">
       Read
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#basic-exercise-2-create-and-write-30">
     Basic Exercise 2 - Create and Write - 30%
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#create">
       Create
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#write">
       Write
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#advanced-exercises">
   Advanced Exercises
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#advanced-exercise-1-memory-cached-sd-card-40">
     Advanced Exercise 1 - Memory Cached SD Card - 40%
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#file-metadata">
       File Metadata
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#directory-entry">
       Directory Entry
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#file-content">
       File Content
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#sync">
       Sync
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#test">
     Test
    </a>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Lab 8: Non-volatile Storage</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#goals-of-this-lab">
   Goals of this lab
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#background">
   Background
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fat-file-system">
     FAT File System
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#short-file-names-sfn-and-long-file-names-lfn">
     Short File Names (SFN) and Long File Names (LFN)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sd-card">
     SD Card
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#sd-card-driver">
       SD Card Driver
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#sd-card-on-qemu">
       SD Card on QEMU
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#sd-card-on-linux">
       SD Card on Linux
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#sector">
       Sector
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#block">
       Block
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#cluster">
       Cluster
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#basic-exercises">
   Basic Exercises
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#get-partition">
     Get Partition
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mount-fat32">
     Mount FAT32
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#basic-exercise-1-open-and-read-40">
     Basic Exercise 1 - Open and Read - 40%
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#lookup-and-open">
       Lookup and Open
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#read">
       Read
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#basic-exercise-2-create-and-write-30">
     Basic Exercise 2 - Create and Write - 30%
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#create">
       Create
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#write">
       Write
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#advanced-exercises">
   Advanced Exercises
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#advanced-exercise-1-memory-cached-sd-card-40">
     Advanced Exercise 1 - Memory Cached SD Card - 40%
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#file-metadata">
       File Metadata
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#directory-entry">
       Directory Entry
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#file-content">
       File Content
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#sync">
       Sync
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#test">
     Test
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section id="lab-8-non-volatile-storage">
<h1>Lab 8: Non-volatile Storage<a class="headerlink" href="#lab-8-non-volatile-storage" title="Permalink to this headline">#</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">#</a></h2>
<p>In previous lab, files were stored in memory, which is volatile.
In this lab, you’ll implement FAT32 that stores data in SD card.</p>
</section>
<section id="goals-of-this-lab">
<h2>Goals of this lab<a class="headerlink" href="#goals-of-this-lab" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Understand how to interact with SD card.</p></li>
<li><p>Implement FAT32 file system.</p></li>
<li><p>Understand memory cache for slow storage mediums.</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It’s better to do this lab on qemu first, and backup your SD card as disk image when you run on real SD card,
so you can <code class="docutils literal notranslate"><span class="pre">dd</span></code> to restore if you broke your FAT32 partition</p>
</div>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">#</a></h2>
<section id="fat-file-system">
<h3>FAT File System<a class="headerlink" href="#fat-file-system" title="Permalink to this headline">#</a></h3>
<p>FAT is a simple and widely used file system.
There is at least one file allocation table, which stores the allocation status.
The entry size can be either 12 bit, 16 bit, or 32 bit.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>FAT is a portable file system, hence, your FAT32 driver should be compatible with others.</p>
</div>
</section>
<section id="short-file-names-sfn-and-long-file-names-lfn">
<h3>Short File Names (SFN) and Long File Names (LFN)<a class="headerlink" href="#short-file-names-sfn-and-long-file-names-lfn" title="Permalink to this headline">#</a></h3>
<p>Originally, FAT uses 8 bytes to store file name and 3 bytes to store extension name,
for example: <code class="docutils literal notranslate"><span class="pre">&quot;a.out&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;a&quot;</span></code> stored in the file name, <code class="docutils literal notranslate"><span class="pre">&quot;out&quot;</span></code> stored in extension name and <code class="docutils literal notranslate"><span class="pre">&quot;.&quot;</span></code> is ignored.</p>
<p>However, it limits the file name’s length and encoding, hence, LFN was invented to fix this problem.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">nctuos.img</span></code> we provide in lab0 is using LFN,
so we provide a new <a class="reference external" href="https://github.com/GrassLab/osdi/raw/master/supplement/sfn_nctuos.img">sfn_nctuos.img</a> ,
which is using SFN, and the <code class="docutils literal notranslate"><span class="pre">kernel8.img</span></code> inside prints out the first block
and the first partition block of the SD card.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>SFN is easier to implement than LFN, you can choose either one to implement.
We won’t test against LFN, but you might need to change your configuration to use SFN.
Ex. initramfs.cpio needs to be renamed, and modify config.txt so bootloader can load it.</p>
</div>
</section>
<section id="sd-card">
<h3>SD Card<a class="headerlink" href="#sd-card" title="Permalink to this headline">#</a></h3>
<section id="sd-card-driver">
<h4>SD Card Driver<a class="headerlink" href="#sd-card-driver" title="Permalink to this headline">#</a></h4>
<p>We provide an <a class="reference external" href="https://github.com/GrassLab/osdi/raw/master/supplement/sdhost.c">SD card driver</a> for you.</p>
<p>You should first call the <code class="docutils literal notranslate"><span class="pre">sd_init</span></code> to initialize the SD card.
Then you can use <code class="docutils literal notranslate"><span class="pre">readblock</span></code> / <code class="docutils literal notranslate"><span class="pre">writeblock</span></code> to R/W 512 bytes from/to SD card.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You should modify the code to meet your requirements.</p>
</div>
</section>
<section id="sd-card-on-qemu">
<h4>SD Card on QEMU<a class="headerlink" href="#sd-card-on-qemu" title="Permalink to this headline">#</a></h4>
<p>You can add the argument <code class="docutils literal notranslate"><span class="pre">-drive</span> <span class="pre">if=sd,file=&lt;img&gt;,format=raw</span></code> to attach an disk image to QEMU.</p>
</section>
<section id="sd-card-on-linux">
<h4>SD Card on Linux<a class="headerlink" href="#sd-card-on-linux" title="Permalink to this headline">#</a></h4>
<p>In Linux, you can set up a loop device for a disk image.</p>
<p><code class="docutils literal notranslate"><span class="pre">losetup</span> <span class="pre">-fP</span> <span class="pre">&lt;img&gt;</span></code>: set up a loop device for disk image,
you can use <code class="docutils literal notranslate"><span class="pre">lsblk</span></code> to lookup which loop device it’s attached to</p>
<p><code class="docutils literal notranslate"><span class="pre">losetup</span> <span class="pre">-d</span> <span class="pre">&lt;device&gt;</span></code>: detach the loop device from the disk image.</p>
<p>Then you can mount loop device</p>
<p><code class="docutils literal notranslate"><span class="pre">mount</span> <span class="pre">-t</span> <span class="pre">msdos</span> <span class="pre">&lt;device&gt;</span> <span class="pre">&lt;dir&gt;</span></code>: SFN.</p>
<p><code class="docutils literal notranslate"><span class="pre">mount</span> <span class="pre">-t</span> <span class="pre">vfat</span> <span class="pre">&lt;device&gt;</span> <span class="pre">&lt;dir&gt;</span></code>: LFN.</p>
</section>
<section id="sector">
<h4>Sector<a class="headerlink" href="#sector" title="Permalink to this headline">#</a></h4>
<p>A sector is the smallest unit for a hard drive to manage its data.</p>
</section>
<section id="block">
<h4>Block<a class="headerlink" href="#block" title="Permalink to this headline">#</a></h4>
<p>A block is the smallest unit for a block device driver to read/write a device.</p>
</section>
<section id="cluster">
<h4>Cluster<a class="headerlink" href="#cluster" title="Permalink to this headline">#</a></h4>
<p>A cluster is composed of contiguous blocks.
A file system uses it as a basic unit to store a regular file or a directory.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you use the provided image and driver, sector, block, and cluster are all 512 bytes.</p>
</div>
</section>
</section>
</section>
<section id="basic-exercises">
<h2>Basic Exercises<a class="headerlink" href="#basic-exercises" title="Permalink to this headline">#</a></h2>
<p>In this part, you should mount SD Card’s FAT32 partition on <code class="docutils literal notranslate"><span class="pre">/boot</span></code>.</p>
<section id="get-partition">
<h3>Get Partition<a class="headerlink" href="#get-partition" title="Permalink to this headline">#</a></h3>
<p>You should locate the partition before mount.
SD card was formatted as MBR (normally).
You can parse it to get each partition’s type, size, and block index.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you use the provided image, the FAT32 partition’s block index is 2048.</p>
</div>
</section>
<section id="mount-fat32">
<h3>Mount FAT32<a class="headerlink" href="#mount-fat32" title="Permalink to this headline">#</a></h3>
<p>FAT32 stores its metadata in the first sector of the partition.
You need to do the following things during mounting.</p>
<ol class="arabic simple">
<li><p>Parse the metadata on the SD card.</p></li>
<li><p>Create a kernel object to store the metadata in memory.</p></li>
<li><p>Get the root directory cluster number and create it’s root directory object.</p></li>
</ol>
</section>
<section id="basic-exercise-1-open-and-read-40">
<h3>Basic Exercise 1 - Open and Read - 40%<a class="headerlink" href="#basic-exercise-1-open-and-read-40" title="Permalink to this headline">#</a></h3>
<p>In this part, you need to lookup, open, and read existing files in FAT32.</p>
<section id="lookup-and-open">
<h4>Lookup and Open<a class="headerlink" href="#lookup-and-open" title="Permalink to this headline">#</a></h4>
<p>To look up files in FAT32 directory.</p>
<ol class="arabic simple">
<li><p>Get the cluster number of the directory and calculate its block index.</p></li>
<li><p>Read the first block of the cluster.</p></li>
<li><p>Traverse the directory entries to find the file.</p></li>
</ol>
<p>You can get the first cluster number of the file in the directory entry.</p>
</section>
<section id="read">
<h4>Read<a class="headerlink" href="#read" title="Permalink to this headline">#</a></h4>
<p>After you get the first cluster number of the file, you can use readblock to read the file.</p>
</section>
</section>
<section id="basic-exercise-2-create-and-write-30">
<h3>Basic Exercise 2 - Create and Write - 30%<a class="headerlink" href="#basic-exercise-2-create-and-write-30" title="Permalink to this headline">#</a></h3>
<p>In this part, you need to create, and write files in FAT32.</p>
<section id="create">
<h4>Create<a class="headerlink" href="#create" title="Permalink to this headline">#</a></h4>
<p>To create a new file in FAT32</p>
<ol class="arabic simple">
<li><p>Find an empty entry in the FAT table.</p></li>
<li><p>Find an empty directory entry in the target directory.</p></li>
<li><p>Set them to proper values.</p></li>
</ol>
</section>
<section id="write">
<h4>Write<a class="headerlink" href="#write" title="Permalink to this headline">#</a></h4>
<p>Similar to read, you can use writeblock to write file, you also need to maintain the metadata of file.</p>
</section>
</section>
</section>
<section id="advanced-exercises">
<h2>Advanced Exercises<a class="headerlink" href="#advanced-exercises" title="Permalink to this headline">#</a></h2>
<p>In this part, you create an cache layer for your SD card.</p>
<section id="advanced-exercise-1-memory-cached-sd-card-40">
<h3>Advanced Exercise 1 - Memory Cached SD Card - 40%<a class="headerlink" href="#advanced-exercise-1-memory-cached-sd-card-40" title="Permalink to this headline">#</a></h3>
<p>Accessing an SD card is much slower than accessing memory.
Before a CPU shutdown or an SD card ejected, it is not necessary to synchronize the data between memory and SD card.
Hence, it’s more efficient to preserve the data in memory and use memory as a cache for external storage.</p>
<p>We can categorize the file data on the storage into three types: file content, directory entry, and file metadata.</p>
<section id="file-metadata">
<h4>File Metadata<a class="headerlink" href="#file-metadata" title="Permalink to this headline">#</a></h4>
<p>Besides the content of a file, additional information such as file size is stored in external storage, too.
The additional information is the file’s metadata. There is also metadata for a file system such as FAT tables in FAT.</p>
<p>Those metadata are cached by a file system’s kernel objects.</p>
</section>
<section id="directory-entry">
<h4>Directory Entry<a class="headerlink" href="#directory-entry" title="Permalink to this headline">#</a></h4>
<p>VFS can reduce the time spend on reading directory block and parsing directory entry by a component name cache mechanism.
A component name cache mechanism can be implemented as:</p>
<ol class="arabic simple">
<li><p>Look up the component name cache of the directory first.</p></li>
<li><p>If successfully finds the vnode, return to the vnode. Otherwise, call the lookup method of the underlying file system.</p></li>
<li><p>The underlying file system looks up from external storage.</p></li>
<li><p>If it successfully finds the file, it creates a vnode for the file and put it into the component name cache.</p></li>
</ol>
</section>
<section id="file-content">
<h4>File Content<a class="headerlink" href="#file-content" title="Permalink to this headline">#</a></h4>
<p>A VFS can cache file content in memory by page frames. A page cache mechanism can be implemented as:</p>
<ol class="arabic simple">
<li><p>Check the existence of the file’s page frames when read or write a file.</p></li>
<li><p>If the page frames don’t exist, allocate page frames for the file.</p></li>
<li><p>The underlying file system populates the page frames with the file’s content in external storage if necessary.</p></li>
</ol>
<p>Read or write the page frames of the file.</p>
</section>
<section id="sync">
<h4>Sync<a class="headerlink" href="#sync" title="Permalink to this headline">#</a></h4>
<p>VFS should synchronize the file’s memory cache with the external storage when a user wants to eject it.
Hence, a VFS should provide an API for users to synchronize the data, and the file system should implement
the synchronize method for writing data back to the external storage.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// syscall number 20</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">sync</span><span class="p">();</span><span class="w"></span>
<span class="c1">// this should call VFS api to sync</span>
<span class="c1">// usually it&#39;s calling super_operation sync_fs on all file system</span>
<span class="c1">// but we don&#39;t care how you design it, as long as it syncs.</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You shouldn’t write to SD card until sync is called.
Ex. open() -&gt; write() -&gt; close() -&gt; poweroff
shouldn’t create a file on SD card.</p>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Although normally, filesystem are cached differently for different components (so it’s possible to partial sync).
But we only test against full synchronization, so it is possible to cache at block level.
which means, all block read and write goes through cache layer, and dirty blocks are written back to SD card when synced.</p>
</div>
</section>
</section>
<section id="test">
<h3>Test<a class="headerlink" href="#test" title="Permalink to this headline">#</a></h3>
<p>Put <a class="reference download internal" download="" href="../_downloads/4ee703906d67d0333ef4c215dc060ab3/vfs2.img"><code class="xref download docutils literal notranslate"><span class="pre">vfs2.img</span></code></a> in initramfs.cpio</p>
<p>Put <a class="reference download internal" download="" href="../_downloads/10fbdc3e04b471849e714edcdcf4ce26/FAT_R.TXT"><code class="xref download docutils literal notranslate"><span class="pre">FAT_R.TXT</span></code></a> in your sd card</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>normally for case insensitive file system, the file system driver does case insensitive lookup.
But for your convenience, all filenames we use in FAT32 are upper case.</p>
</div>
<ul class="simple">
<li><p>Run <code class="docutils literal notranslate"><span class="pre">fat_r</span></code> for Basic Exercise 1</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">fat_w</span></code> for Basic Exercise 2</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">fat_ws</span></code> for Advanced Exercise 1</p></li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>you should check your sd card with your computer.
For <code class="docutils literal notranslate"><span class="pre">fat_w</span></code> there should be <code class="docutils literal notranslate"><span class="pre">FAT_W.TXT</span></code>.
For <code class="docutils literal notranslate"><span class="pre">fat_ws</span></code> there should be <code class="docutils literal notranslate"><span class="pre">FAT_WS.TXT</span></code>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you’ve implement advance exercise 1, run <code class="docutils literal notranslate"><span class="pre">fat_ws</span></code> before <code class="docutils literal notranslate"><span class="pre">fat_w</span></code> and then power off.
There should be <code class="docutils literal notranslate"><span class="pre">FAT_WS.TXT</span></code> but not <code class="docutils literal notranslate"><span class="pre">FAT_W.TXT</span></code></p>
</div>
</section>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="lab7.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Lab 7: Virtual File System</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="hardware/index.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Hardware</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Jim, Muller<br/>
  
      &copy; Copyright 2021, Jim, Muller.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>